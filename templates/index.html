<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>图片视频二维码生成器</title>
    <style>
      body {
        font-family: "Microsoft YaHei", Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #555;
      }
      .file-upload-area {
        border: 2px dashed #007bff;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
        cursor: pointer;
      }
      .file-upload-area:hover {
        border-color: #0056b3;
        background-color: #e9ecef;
      }
      .file-upload-area.dragover {
        border-color: #28a745;
        background-color: #d4edda;
      }
      input[type="file"] {
        display: none;
      }
      .upload-icon {
        font-size: 48px;
        color: #007bff;
        margin-bottom: 15px;
      }
      .file-info {
        margin-top: 15px;
        padding: 10px;
        background-color: #e9ecef;
        border-radius: 5px;
        display: none;
      }
      .preview-area {
        margin-top: 20px;
        text-align: center;
        display: none;
      }
      .preview-image,
      .preview-video {
        max-width: 100%;
        max-height: 300px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      button {
        background-color: #007bff;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        width: 100%;
        margin-top: 10px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .result {
        margin-top: 30px;
        padding: 20px;
        border-radius: 5px;
        display: none;
      }
      .success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .qrcode-display {
        text-align: center;
        margin-top: 20px;
      }
      .qrcode-display img {
        max-width: 300px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .download-btn {
        background-color: #28a745;
        margin-top: 10px;
        width: auto;
        display: inline-block;
      }
      .download-btn:hover {
        background-color: #218838;
      }
      .loading {
        display: none;
        text-align: center;
        margin-top: 20px;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 2s linear infinite;
        margin: 0 auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>图片视频二维码生成器</h1>

      <form id="uploadForm" enctype="multipart/form-data">
        <div class="form-group">
          <label>选择图片或视频文件：</label>
          <div class="file-upload-area" id="uploadArea">
            <div class="upload-icon">📁</div>
            <p>点击选择文件或拖拽文件到此处</p>
            <p style="color: #666; font-size: 14px; margin-top: 10px">支持格式：PNG, JPG, JPEG, GIF, MP4, AVI, MOV, WMV, FLV, WEBM, MKV</p>
            <p style="color: #666; font-size: 12px; margin-top: 5px">最大文件大小：500MB</p>
          </div>
          <input type="file" id="fileInput" name="file" accept="image/*,video/*" />
          <div class="file-info" id="fileInfo"></div>
          <div class="preview-area" id="previewArea"></div>
        </div>
        <button type="submit" id="uploadBtn" disabled>上传并生成二维码</button>
      </form>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>正在生成并上传二维码...</p>
      </div>

      <div class="result" id="result">
        <div id="resultContent"></div>
        <div class="qrcode-display" id="qrcodeDisplay"></div>
      </div>
    </div>

    <script>
      // 文件上传相关变量
      let selectedFile = null;

      // 文件上传区域事件
      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");
      const fileInfo = document.getElementById("fileInfo");
      const previewArea = document.getElementById("previewArea");
      const uploadBtn = document.getElementById("uploadBtn");

      // 点击上传区域
      uploadArea.addEventListener("click", () => fileInput.click());

      // 文件选择
      fileInput.addEventListener("change", handleFileSelect);

      // 拖拽上传
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          fileInput.files = files;
          handleFileSelect();
        }
      });

      function handleFileSelect() {
        const file = fileInput.files[0];
        if (file) {
          selectedFile = file;
          showFileInfo(file);
          showPreview(file);
          uploadBtn.disabled = false;
        }
      }

      function showFileInfo(file) {
        const fileSize = (file.size / (1024 * 1024)).toFixed(2);
        fileInfo.innerHTML = `
           <strong>已选择文件：</strong>${file.name}<br>
           <strong>文件大小：</strong>${fileSize} MB<br>
           <strong>文件类型：</strong>${file.type}
         `;
        fileInfo.style.display = "block";
      }

      function showPreview(file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          if (file.type.startsWith("image/")) {
            previewArea.innerHTML = `
               <img src="${e.target.result}" class="preview-image" alt="预览图片">
             `;
          } else if (file.type.startsWith("video/")) {
            previewArea.innerHTML = `
               <video src="${e.target.result}" class="preview-video" controls>
                 您的浏览器不支持视频播放。
               </video>
             `;
          }
          previewArea.style.display = "block";
        };
        reader.readAsDataURL(file);
      }

      // 表单提交
      document.getElementById("uploadForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        if (!selectedFile) {
          alert("请选择要上传的文件");
          return;
        }

        const loading = document.getElementById("loading");
        const result = document.getElementById("result");
        const resultContent = document.getElementById("resultContent");
        const qrcodeDisplay = document.getElementById("qrcodeDisplay");

        // 显示加载状态
        uploadBtn.disabled = true;
        loading.style.display = "block";
        result.style.display = "none";

        try {
          const formData = new FormData();
          formData.append("file", selectedFile);

          const response = await fetch("/api/upload", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          // 隐藏加载状态
          loading.style.display = "none";
          uploadBtn.disabled = false;

          if (data.success) {
            result.className = "result success";
            resultContent.innerHTML = `
                         <h3>上传成功！</h3>
                         <p><strong>文件名称：</strong>${data.filename}</p>
                         <p><strong>播放链接：</strong><a href="${data.play_url}" target="_blank">${data.play_url}</a></p>
                         <p>${data.message}</p>
                     `;

            qrcodeDisplay.innerHTML = `
                         <img src="${data.qrcode_url}" alt="生成的二维码" id="qrcodeImg">
                         <br>
                         <button class="download-btn" onclick="downloadQrcode('${data.file_id}')">下载二维码</button>
                     `;
          } else {
            result.className = "result error";
            resultContent.innerHTML = `
                        <h3>生成失败</h3>
                        <p>${data.error}</p>
                        ${data.details ? `<p><strong>详细信息：</strong>${data.details}</p>` : ""}
                    `;
            qrcodeDisplay.innerHTML = "";
          }

          result.style.display = "block";
        } catch (error) {
          loading.style.display = "none";
          uploadBtn.disabled = false;

          result.className = "result error";
          resultContent.innerHTML = `
                    <h3>请求失败</h3>
                    <p>网络错误：${error.message}</p>
                `;
          qrcodeDisplay.innerHTML = "";
          result.style.display = "block";
        }
      });

      function downloadQrcode(fileId) {
        window.open(`/download/${fileId}`, "_blank");
      }
    </script>
  </body>
</html>
